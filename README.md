# ipfs-media-delivery-network

# Децентрализованный сервис обмена медиа контентом поверх IPFS

## 3 типа участников:
1.1 ) Гости - самый широкий слой клиентов - read only. (Самый внешний слой, без хостинга IPFS нод)
Любые плееры, которые зная CID контента могут его получить через публичные IPFS шлюзы.
Мобильные приложения, локальные/embeded плееры и медиацентры, in-browser плееры.
Могут по api подключаться к индексаторам и находить необохдимый контент.

1.2 ) Пользователи с IPFS бэкендом. (IPFS ноды и специальные клиенты)
Если у плеера есть прямая интеграция с ipfs нодой по ключу, то пользователь может пинить контент своих плейлистов (и сами листы) в свои ipfs ноды.
Логично, что ipfs ноды не хостятся на мобильных устройствах. Это могут быть клауд-сервисы типа pinata или self-hosted.
Тут-же можно учитывать ipfs шлюзы, которые кэшируют контент (обычные ipfs ноды).

2 ) Индексаторы - (IPFS + слой метаданых)
Поисковик, который может поднять кто угодно и получить свой индекс.
- собирают метаданные о контенте
- строят поисковые индексы
- предоставляют полнотекстовый поиск
- валидируют наличие контента
- строят рекомендации
- участвуют в поддержке распространении актуальных метаданных
- обновляют метаданные (проверка битрейта, обновление обложки, обновление тэгов и названий)
У индексаторов будет достаточно данных для вышеуказанных задач.

3 ) Публикаторы (метаданные + контент)
Самописное приложение - агент.
Должен создавать/структурировать метаданные, предоставлять их индексаторам и самое главное - публиковать/хостить контент.
Публиковать - заливать и пинить контент на внешние IPFS ноды.
Хостить - если IPFS нода локально вместе с контентом, тогда добавлять контент через --nocopy

---
### Что это нам дает и какие бонусы от IPFS?
- можно pin-ить данные на managed ipfs хостинги типа pinata.cloud.
- кэширование контента на публичных ipfs шлюзах (снимает нагрузку с канала сидеров)
- возможность раздавать контент даже не имея белого IP (через публичные шлюзы)
- легпо поднять шлюз в приватные/оверлейные сети (tor/i2p)
- возможность закешировать свою библиотеку на свой домашний ipfs, что гарантирует сохранность контента. Собрав коллекцию медиафайлов в плейлисты ты, придя домой, нажимаешь PIN all на свой ipfs сервер. И данные сами собой резервируются на твой домашний сервер. Можно быть уверенным, что никакой стриминг сервис их не удалит.

## FAQ:
### Почему не Personal streaming service? (Navidrome, Polaris)
- такая реализация должна покрывать всё, что умеет personal streaming service
- не нужен домен/ip
- есть поиск по глобальному каталогу за пределами персональной коллекции
- возможна интеграция с любым медиа плеером

### Почему не soulseek (fileshare / torrents)?
- главное отличие - прозрачная интеграция в любые медиаплееры. Контент доступен по прямой https ссылке
- нет ценртального сервера, на который всё завязано
- открытый протокол и транспорт (IPFS)
- более гибкий поиск. можно реализовать что угодно, т.к. поисковик локальный и самописный
- прямая интеграция в плееры без промежуточного скачивания
- возможна самостоятельная реализация сервиса рекомендаций

### Почему в архитектуре не OrbitDB?
ObritDB хранит записи базы с линками друг к другу (почти как blockchain)
- индексатору для начала построения индекса нужно выкачивать полностью всю базу
- ссылки на удалённые и недоступные данные всё ещё остаются в базе
- на больших объемах и долгом времени использования база разрастется до неподъемных размеров

---

## Транспорт и структура метаданных.
Индексаторы должны иметь возможность однозначно определять публикатора по его публичному ключу, чтобы фильтровать битые/фейковые данные. Это позволяет IPNS.
1) Публикатор заливает файлы в ipfs, для каждого генерирует метаданные.
Структура метаданных на первом этапе плоская (<Имя файла> - <CID файла>). Но в дальнейшем можно расширять слой метаданных (<Имя файла> - <CID IPLD>).
В IPLD может храниться json с описанием медиа файла, содержанием id3 тэга, ссылкой на CID обложки и ссылкой на CID самого файла.
Либо IPLD с названием и обложкой альбома, содержимым CUE файла и CID на сам файл.
В результате у публикатора получается огромный лист с его контентом в виде "название - cid". Этот лист он подписывает и публикует на него IPNS ссылку в DHT(ttl 24h).
2) Публикатор оповещает в PubSub канале об обновлении ipns ссылки.
3) Индексаторы, подписанные на PubSub получают IPNS ссылки на базы контента публикаторов. По этой ссылке мы получаем файл или папку с файлами в виде json листа со списком ссылок на метаданные/файлы.
4) Индексатор выкачивает данные себе, строит поисковый индекс, проверяет наличие данных в IPFS. В индексе обязательно сохраняется публичный ключ публикатора для контроля качества контента, чтобы можно было при желании весь объём данных повысить / понизить в выдаче или совсем удалить из индекса.

Плейлист для музыкального плеера может представлять из себя список /ipfs /ipns ссылок, которые при необходимости резолвятся в https ссылку на публичный шлюз, либо при прямой интеграции плеера с ipfs предоставляют доступ к контенту.

### Как вновь подключенным индексаторам найти корневые ipns ссылки у авторов без ожидания PubSub?
В PubSub создается второй канал на который подписываются все паблишеры. Индексатор через этот канал просит всех продублировать данные и ждет ответы в основном канале.


### Если паблишер уходит с раздачи.
1) IPNS протухает через 24 часа в DHT. Если паблишера нет в сети, тогда метаданные его коллекции становятся недоступными вместе с самим контентом. Если какая-то часть контента закеширована / запинена другими нодами, то она остается доступна. Метаданные к этому моменту должны быть уже на индексаторах и доступны для поиска.
2) У индексаторов часть контента становится недоступна.
Если паблишеры ушли, то часть CID будет недоступна для скачивания. Можно в фоновом режиме проверять ipfs dht findprovs <CID> и помечать, что контент недоступен с текущего момента.